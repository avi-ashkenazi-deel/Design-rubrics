<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiring at Deel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #141414;
            --bg-surface: #1a1a1a;
            --bg-elevated: #1f1f1f;
            --border-color: #2a2a2a;
            --border-hover: #3a3a3a;
            
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #6a6a6a;
            
            --neon-red: #ff5c5c;
            --neon-orange: #ff9f43;
            --neon-green: #50fa7b;
            --neon-cyan: #8be9fd;
            --neon-purple: #bd93f9;
            
            --glow-red: 0 0 20px rgba(255, 92, 92, 0.3);
            --glow-orange: 0 0 20px rgba(255, 159, 67, 0.3);
            --glow-green: 0 0 20px rgba(80, 250, 123, 0.3);
            --glow-cyan: 0 0 20px rgba(139, 233, 253, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        /* Form Controls */
        label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 6px;
        }

        select, input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        select:hover, input:hover {
            border-color: var(--border-hover);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 0 3px rgba(139, 233, 253, 0.1);
        }

        select option {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            background: var(--bg-elevated);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--bg-surface);
            border-color: var(--border-hover);
        }

        .btn-primary {
            background: var(--neon-cyan);
            color: var(--bg-primary);
            border-color: var(--neon-cyan);
        }

        .btn-primary:hover {
            background: #7dd3e8;
            border-color: #7dd3e8;
        }

        .btn-add {
            background: transparent;
            border: 1px dashed var(--border-hover);
            color: var(--text-secondary);
        }

        .btn-add:hover:not(:disabled) {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .btn-add:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-remove {
            padding: 4px 8px;
            font-size: 11px;
            background: rgba(255, 92, 92, 0.1);
            border-color: transparent;
            color: var(--neon-red);
        }

        .btn-remove:hover {
            background: rgba(255, 92, 92, 0.2);
        }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
            background: var(--bg-primary);
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            width: fit-content;
        }

        .status-badge.loaded {
            background: rgba(80, 250, 123, 0.15);
            color: var(--neon-green);
        }

        .status-badge.error {
            background: rgba(255, 92, 92, 0.15);
            color: var(--neon-red);
        }

        .status-badge.loading {
            background: rgba(139, 233, 253, 0.15);
            color: var(--neon-cyan);
        }

        .status-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Comparison Grid */
        .comparison-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comparison-header {
            display: flex;
            gap: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .comparison-header-item {
            flex: 1;
            min-width: 0;
        }

        .level-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }

        .level-title {
            font-size: 14px;
            font-weight: 600;
        }

        .competency-row {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .competency-row:hover {
            border-color: var(--border-hover);
        }

        .competency-header {
            padding: 16px 20px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .competency-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--bg-elevated);
        }

        .competency-name {
            font-size: 15px;
            font-weight: 600;
        }

        .competency-title-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .info-icon:hover {
            background: var(--neon-cyan);
            border-color: var(--neon-cyan);
            color: var(--bg-primary);
            box-shadow: var(--glow-cyan);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--bg-elevated);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--neon-red);
            border-color: var(--neon-red);
            color: white;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }

        .modal-focus-area {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(189, 147, 249, 0.15);
            color: var(--neon-purple);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .modal-description {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-secondary);
        }


        /* Competencies Definition View */
        .competencies-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .competency-definition-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .competency-definition-card:hover {
            border-color: var(--border-hover);
        }

        .competency-definition-header {
            padding: 16px 20px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .competency-definition-body {
            padding: 20px;
        }

        .competency-definition-text {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .focus-area-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(189, 147, 249, 0.15);
            color: var(--neon-purple);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        /* See Questions Toggle Button */
        .questions-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .questions-toggle:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .questions-toggle.active {
            background: rgba(139, 233, 253, 0.15);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .questions-toggle-icon {
            font-size: 14px;
        }

        /* Questions Column */
        .compare-table-wrapper {
            display: flex;
            gap: 0;
        }

        .questions-panel {
            flex: 0 0 340px;
            min-width: 340px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .questions-panel-header {
            padding: 14px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--neon-orange);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
        }

        .questions-panel-content {
            padding: 16px;
            font-size: 13px;
            line-height: 1.8;
            color: var(--text-secondary);
            overflow-y: auto;
            flex: 1;
        }

        .questions-panel-content ul {
            margin: 0;
            padding-left: 18px;
            list-style-type: disc;
        }

        .questions-panel-content li {
            margin-bottom: 12px;
            padding-right: 8px;
        }

        .questions-panel-content li:last-child {
            margin-bottom: 0;
        }

        .compare-table-main {
            flex: 1;
            min-width: 0;
        }

        .no-questions {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Transcript Analysis Styles */
        .transcript-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .transcript-input-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .transcript-input-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .input-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--neon-cyan);
        }

        .transcript-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 16px;
        }

        .transcript-textarea:focus {
            outline: none;
            border-color: var(--neon-cyan);
        }

        .transcript-textarea::placeholder {
            color: var(--text-muted);
        }

        .analyze-btn {
            padding: 12px 24px;
            background: var(--neon-cyan);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analyze-btn:hover {
            background: #7dd3e8;
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .analyze-btn.loading {
            position: relative;
            color: transparent;
        }

        .analyze-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--bg-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Section */
        .transcript-results {
            display: none;
        }

        .transcript-results.visible {
            display: block;
        }

        .results-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-info {
            display: flex;
            gap: 24px;
        }

        .results-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .results-info-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .results-info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .overall-score {
            text-align: right;
        }

        .overall-score-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .overall-score-value {
            font-size: 28px;
            font-weight: 700;
        }

        .overall-score-value.high { color: var(--neon-green); }
        .overall-score-value.medium { color: var(--neon-orange); }
        .overall-score-value.low { color: var(--neon-red); }

        /* Competency Results Cards */
        .competency-results-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .competency-result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .competency-result-header {
            padding: 16px 20px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .competency-result-title {
            font-size: 15px;
            font-weight: 600;
        }

        .competency-score-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .competency-score-badge.high {
            background: rgba(80, 250, 123, 0.15);
            color: var(--neon-green);
        }

        .competency-score-badge.medium {
            background: rgba(255, 159, 67, 0.15);
            color: var(--neon-orange);
        }

        .competency-score-badge.low {
            background: rgba(255, 92, 92, 0.15);
            color: var(--neon-red);
        }

        .competency-result-body {
            padding: 16px 20px;
        }

        .question-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .question-item:last-child {
            margin-bottom: 0;
        }

        .question-item.covered {
            background: rgba(80, 250, 123, 0.1);
            border-color: rgba(80, 250, 123, 0.3);
            color: var(--text-primary);
        }

        .question-item.covered::before {
            content: '✓ ';
            color: var(--neon-green);
            font-weight: 600;
        }

        .question-item.not-covered {
            opacity: 0.6;
        }

        .question-item.not-covered::before {
            content: '○ ';
            color: var(--text-muted);
        }

        .competency-content {
            display: flex;
            gap: 16px;
            padding: 16px;
        }

        .score-column {
            flex: 1;
            min-width: 0;
        }

        /* Score Cards */
        .score-card {
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            height: 100%;
            transition: all 0.2s ease;
        }

        .score-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .score-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
        }

        .score-badge.score-1 {
            background: rgba(255, 92, 92, 0.15);
            color: var(--neon-red);
            box-shadow: var(--glow-red);
        }

        .score-badge.score-2 {
            background: rgba(255, 159, 67, 0.15);
            color: var(--neon-orange);
            box-shadow: var(--glow-orange);
        }

        .score-badge.score-3 {
            background: rgba(80, 250, 123, 0.15);
            color: var(--neon-green);
            box-shadow: var(--glow-green);
        }

        .score-badge.score-4 {
            background: rgba(139, 233, 253, 0.15);
            color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .score-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .score-label.fail {
            color: var(--neon-orange);
        }

        .score-label.pass {
            color: var(--neon-green);
        }

        .score-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* Level Comparison Cards */
        .level-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            height: 100%;
        }

        .level-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .level-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--neon-purple);
        }

        .level-card-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .level-score-row {
            display: flex;
            gap: 8px;
        }

        .level-score-item {
            flex: 1;
            padding: 10px;
            background: var(--bg-surface);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .level-score-item .score-badge {
            margin-bottom: 8px;
        }

        .level-score-item .score-text {
            font-size: 12px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            background: var(--bg-secondary);
            border: 1px dashed var(--border-color);
            border-radius: 16px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .empty-state code {
            display: inline-block;
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--neon-cyan);
            margin-top: 12px;
        }

        /* Comparison Columns */
        .comparison-columns {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .comparison-column {
            flex: 1;
            min-width: 0;
        }

        .comparison-column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Scrollable content */
        .content-area {
            max-width: 1400px;
        }

        /* Data Status Bar */
        .data-status-sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .data-info {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading .status-dot {
            animation: pulse 1.5s infinite;
        }

        /* Filter group */
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Instructions panel */
        .instructions {
            padding: 10px 12px;
            background: var(--bg-surface);
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        /* Highlight differences */
        .highlighted {
            background: rgba(255, 159, 67, 0.1);
            border-color: var(--neon-orange) !important;
        }

        /* Compare Table Layout */
        .compare-table {
            width: 100%;
            border-collapse: collapse;
        }

        .compare-table-header {
            display: flex;
            gap: 1px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
        }

        .compare-table-header .compare-table-cell {
            padding: 14px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .compare-table-header .level-header-cell {
            color: var(--neon-purple);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-icon {
            font-size: 16px;
        }

        .compare-table-row {
            display: flex;
            gap: 1px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .compare-table-row:last-child {
            border-bottom: none;
        }

        .compare-table-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .compare-table-row.fail-row {
            background: rgba(255, 92, 92, 0.03);
        }

        .compare-table-row.pass-row {
            background: rgba(80, 250, 123, 0.03);
        }

        .compare-table-cell {
            flex: 1;
            padding: 16px;
            min-width: 0;
        }

        .score-label-cell {
            flex: 0 0 70px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-color);
        }

        .score-status {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-status.fail {
            color: var(--neon-orange);
        }

        .score-status.pass {
            color: var(--neon-green);
        }

        .compare-cell-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .compare-table-cell:not(.score-label-cell) {
            border-right: 1px solid var(--border-color);
        }

        .compare-table-cell:last-child {
            border-right: none;
        }

        /* Multi-select dropdown */
        .multi-select {
            position: relative;
        }

        .multi-select-toggle {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .multi-select-toggle:hover {
            border-color: var(--border-hover);
        }

        .multi-select.open .multi-select-toggle {
            border-color: var(--neon-cyan);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .multi-select-arrow {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .multi-select.open .multi-select-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--neon-cyan);
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            z-index: 100;
            padding: 4px 0;
        }

        .multi-select.open .multi-select-dropdown {
            display: block;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .checkbox-item:hover {
            background: var(--bg-surface);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--neon-cyan);
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span>Hiring at Deel</span>
            </div>

            <!-- View Switcher -->
            <div class="section">
                <div class="section-title">View</div>
                <div class="filter-group">
                    <select id="view-select" onchange="switchView(this.value)">
                        <option value="rubric">Hiring Rubric</option>
                        <option value="definitions">Competencies Definition</option>
                        <option value="transcript">Transcript Analysis</option>
                    </select>
                </div>
            </div>

            <!-- Discipline -->
            <div class="section">
                <div class="section-title">Discipline</div>
                <div class="filter-group">
                    <select id="discipline-select" onchange="onDisciplineChange()">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>

            <!-- Filters -->
            <div class="section" id="filters-section">
                <div class="filter-group">
                    <label for="compare-stage">Interview Stage</label>
                    <select id="compare-stage" onchange="onStageChange()">
                        <option value="">Select stage...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="compare-competency">Competency</label>
                    <select id="compare-competency" onchange="updateCompareView()">
                        <option value="">All competencies</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Score Level</label>
                    <div class="multi-select" id="score-multi-select">
                        <div class="multi-select-toggle" onclick="toggleScoreDropdown()">
                            <span class="multi-select-label" id="score-select-label">All scores</span>
                            <span class="multi-select-arrow">▾</span>
                        </div>
                        <div class="multi-select-dropdown" id="score-dropdown">
                            <label class="checkbox-item">
                                <input type="checkbox" value="1" onchange="updateScoreSelection()">
                                <span class="checkbox-label">1</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="2" onchange="updateScoreSelection()">
                                <span class="checkbox-label">2</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="3" onchange="updateScoreSelection()">
                                <span class="checkbox-label">3</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="4" onchange="updateScoreSelection()">
                                <span class="checkbox-label">4</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Levels -->
            <div class="section" id="compare-levels-section">
                <div class="section-title">Compare Levels</div>
                <div id="compare-levels-container">
                    <div class="filter-group">
                        <select class="compare-level-select" onchange="onLevelSelectChange()">
                            <option value="">Select level...</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-add" id="add-level-btn" onclick="addComparisonColumn()" style="display: none;">
                    + Add Level to Compare
                </button>
            </div>

            <!-- Data Actions -->
            <div class="section" style="margin-top: auto;">
                <div class="section-title">Data</div>
                <div class="data-status-sidebar" id="data-status-sidebar">
                    <span class="status-badge loading" id="data-status">
                        <span class="status-dot"></span>
                        Loading...
                    </span>
                    <span class="data-info" id="data-info">Fetching data...</span>
                </div>
                <button class="btn" onclick="reloadData()">
                    Reload Data
                </button>
                <div class="instructions" id="last-updated-info">
                    Loading file info...
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <div class="header">
                <h1 id="current-view-title">Hiring Rubric</h1>
                <p id="view-subtitle">Compare competency requirements side-by-side across different designer levels</p>
            </div>
            <div class="content-area" id="compare-content">
                <div class="empty-state">
                    <h3>Compare designer levels</h3>
                    <p>Select an interview stage and add levels to compare their requirements side-by-side.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Competency Definition Modal -->
    <div class="modal-overlay" id="competency-modal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-wrapper">
                    <div class="modal-title" id="modal-title">Competency</div>
                </div>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-focus-area" id="modal-focus-area">Focus Area</div>
                <div class="modal-description" id="modal-description">
                    Description will appear here.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let rubricData = [];
        let competencyDefinitions = {};
        let questionsData = {}; // Questions keyed by "stage_competency"
        let showQuestionsState = {}; // Track which competencies have questions visible
        let selectedScores = [1, 2, 3, 4]; // All scores selected by default
        let currentView = 'rubric'; // 'rubric' or 'definitions'
        let currentDiscipline = 'Design'; // Current selected discipline
        let disciplineConfig = null; // Current discipline configuration

        // Discipline icons (disabled)
        const disciplineIcons = {};

        // Default icon for unknown disciplines
        const defaultDisciplineIcon = '';

        // Competency icons (disabled)
        const competencyIcons = {};

        // Designer level icons and classes
        const levelConfig = {
            'Product Designer': { icon: '', class: 'junior' },
            'Senior Product Designer': { icon: '', class: 'senior' },
            'Staff Product Designer': { icon: '', class: 'staff' },
            'Senior Staff Product Designer': { icon: '', class: 'senior-staff' }
        };

        // Stage display names (for UI display)
        const stageDisplayNames = {
            'Portfolio': 'Portfolio (Async)'
        };

        // Get display name for a stage
        function getStageDisplayName(stage) {
            return stageDisplayNames[stage] || stage;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDisciplines();
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                const multiSelect = document.getElementById('score-multi-select');
                if (!multiSelect.contains(e.target)) {
                    multiSelect.classList.remove('open');
                }
            });
        });

        // Initialize disciplines
        async function initializeDisciplines() {
            const select = document.getElementById('discipline-select');
            select.innerHTML = '<option value="">Loading...</option>';
            
            const disciplines = await loadDisciplines();
            
            if (disciplines.length === 0) {
                select.innerHTML = '<option value="">No disciplines found</option>';
                updateDataStatus('error', 'No disciplines found in disciplines/ folder');
                return;
            }
            
            // Populate dropdown
            select.innerHTML = '';
            disciplines.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.add(option);
            });
            
            // Select first discipline
            currentDiscipline = disciplines[0];
            select.value = currentDiscipline;
            
            // Load data for selected discipline
            await loadDisciplineData();
        }

        // Load data for current discipline
        async function loadDisciplineData() {
            disciplineConfig = await loadDisciplineConfig(currentDiscipline);
            await loadCompetencyDefinitions();
            await loadQuestions();
            await loadData();
        }

        // Handle discipline change
        async function onDisciplineChange() {
            const select = document.getElementById('discipline-select');
            currentDiscipline = select.value;
            
            // Clear existing data
            rubricData = [];
            competencyDefinitions = {};
            questionsData = {};
            showQuestionsState = {};
            
            // Reload data for new discipline
            await loadDisciplineData();
            
            // Refresh current view
            if (currentView === 'definitions') {
                renderDefinitionsView();
            } else {
                updateCompareView();
            }
        }

        function toggleScoreDropdown() {
            const multiSelect = document.getElementById('score-multi-select');
            multiSelect.classList.toggle('open');
        }

        function updateScoreSelection() {
            const checkboxes = document.querySelectorAll('#score-dropdown input[type="checkbox"]');
            selectedScores = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));
            
            // If none selected, show all
            if (selectedScores.length === 0) {
                selectedScores = [1, 2, 3, 4];
            }
            
            // Update label
            const label = document.getElementById('score-select-label');
            if (selectedScores.length === 4) {
                label.textContent = 'All scores';
            } else {
                label.textContent = selectedScores.sort().join(', ');
            }
            
            updateCompareView();
        }

        // Get CSV files for current discipline (dynamically from config)
        function getCsvFiles() {
            return disciplineConfig?.levels || [];
        }

        // Get competencies file for current discipline
        function getCompetenciesFile() {
            return `disciplines/${currentDiscipline}/Competencies.csv`;
        }

        // Load disciplines index
        async function loadDisciplines() {
            try {
                const response = await fetch('disciplines/index.json');
                if (!response.ok) {
                    throw new Error('index.json not found');
                }
                const data = await response.json();
                return data.disciplines || [];
            } catch (error) {
                console.warn('Could not load disciplines index, trying to detect Design folder...');
                // Fallback: try to detect Design discipline
                try {
                    const testResponse = await fetch('disciplines/Design/Competencies.csv');
                    if (testResponse.ok) {
                        return ['Design'];
                    }
                } catch (e) {}
                return [];
            }
        }

        // Load discipline configuration
        async function loadDisciplineConfig(discipline) {
            try {
                const response = await fetch(`disciplines/${discipline}/config.json`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn(`No config.json for ${discipline}, auto-detecting CSVs...`);
            }
            
            // Auto-detect CSV files in the discipline folder
            return await autoDetectDisciplineConfig(discipline);
        }

        // Auto-detect CSV files for a discipline
        async function autoDetectDisciplineConfig(discipline) {
            const commonLevelFiles = [
                { file: 'PD.csv', level: 'Product Designer' },
                { file: 'SPD.csv', level: 'Senior Product Designer' },
                { file: 'SSPD.csv', level: 'Staff Product Designer' },
                { file: 'SSSPD.csv', level: 'Senior Staff Product Designer' },
                { file: 'SWE.csv', level: 'Software Engineer' },
                { file: 'Senior-SWE.csv', level: 'Senior Software Engineer' },
                { file: 'Staff-SWE.csv', level: 'Staff Software Engineer' },
                { file: 'PM.csv', level: 'Product Manager' },
                { file: 'SPM.csv', level: 'Senior Product Manager' }
            ];
            
            const levels = [];
            
            for (const { file, level } of commonLevelFiles) {
                try {
                    const response = await fetch(`disciplines/${discipline}/${file}`, { method: 'HEAD' });
                    if (response.ok) {
                        levels.push({
                            file: `disciplines/${discipline}/${file}`,
                            level: level
                        });
                    }
                } catch (e) {}
            }
            
            return { levels };
        }

        // Load data from multiple CSV files
        async function loadData() {
            updateDataStatus('loading', 'Loading CSV files...');
            rubricData = [];
            
            const results = { loaded: [], failed: [] };
            const csvFiles = getCsvFiles();
            
            for (const { file, level } of csvFiles) {
                try {
                    const response = await fetch(file);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const csvText = await response.text();
                    
                    const parsed = Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: false
                    });
                    
                    if (parsed.errors.length > 0) {
                        console.warn(`CSV parsing warnings for ${file}:`, parsed.errors);
                    }
                    
                    console.log(`Parsing ${file}, found ${parsed.data.length} rows`);
                    console.log(`First 5 rows of ${file}:`, parsed.data.slice(0, 5));
                    
                    // Find the header row (contains "Assessment Stage" in first cell)
                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(parsed.data.length, 20); i++) {
                        const firstCell = parsed.data[i]?.[0]?.toString().trim() || '';
                        console.log(`Row ${i} first cell: "${firstCell.substring(0, 30)}..."`);
                        if (firstCell.includes('Assessment Stage') || firstCell.includes('Assessment')) {
                            headerRowIndex = i;
                            console.log(`Found header at row ${i}`);
                            break;
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        console.warn(`Could not find header row in ${file}. First 10 rows first cells:`, parsed.data.slice(0, 10).map(r => r?.[0]?.substring?.(0, 30)));
                        results.failed.push(level);
                        continue;
                    }
                    
                    // Process data rows (after header)
                    let currentStage = '';
                    let rowsProcessed = 0;
                    
                    for (let i = headerRowIndex + 1; i < parsed.data.length; i++) {
                        const row = parsed.data[i];
                        
                        // Skip empty rows or rows with not enough columns
                        if (!row || row.length < 4) continue;
                        
                        // Get interview stage (column 0) - may be empty if continuation of previous stage
                        const stage = row[0]?.toString().trim();
                        if (stage && stage.length > 0 && !stage.startsWith(',')) {
                            currentStage = stage;
                        }
                        
                        // Get competency (column 1)
                        let competency = row[1]?.toString().trim() || '';
                        competency = competency.replace(/:$/, '').replace(/:\s*$/, ''); // Remove trailing colon
                        
                        if (!competency || !currentStage) continue;
                        
                        // Get scores - columns 3, 4, 5, 6 for Level 1-4 (new format)
                        const score_1 = row[3]?.toString().trim() || '';
                        const score_2 = row[4]?.toString().trim() || '';
                        const score_3 = row[5]?.toString().trim() || '';
                        const score_4 = row[6]?.toString().trim() || '';
                        
                        // Only add if we have at least some score data
                        if (score_1 || score_2 || score_3 || score_4) {
                            rubricData.push({
                                interview_stage: currentStage,
                                competency: competency,
                                designer_level: level,
                                score_1,
                                score_2,
                                score_3,
                                score_4
                            });
                            rowsProcessed++;
                        }
                    }
                    
                    console.log(`${file}: Processed ${rowsProcessed} competency rows`);
                    
                    if (rowsProcessed > 0) {
                        results.loaded.push(level);
                    } else {
                        console.warn(`No data rows found in ${file}`);
                        results.failed.push(level);
                    }
                } catch (error) {
                    console.error(`Failed to load ${file}:`, error);
                    results.failed.push(level);
                }
            }
            
            console.log('Total rubric data entries:', rubricData.length);
            console.log('Sample entry:', rubricData[0]);
            
            if (results.loaded.length === 0) {
                updateDataStatus('error', 'No CSV files found. Please add your CSV files.');
                showServerInstructions();
                return;
            }
            
            if (results.failed.length > 0) {
                updateDataStatus('loaded', `Loaded ${results.loaded.length}/4 files • Missing: ${results.failed.join(', ')}`);
            } else {
                updateDataStatus('loaded', `All 4 levels loaded • ${rubricData.length} total entries`);
            }
            
            onDataLoaded();
        }

        function reloadData() {
            loadData();
        }

        // Load competency definitions from CSV
        async function loadCompetencyDefinitions() {
            try {
                const competenciesFile = getCompetenciesFile();
                if (!competenciesFile) {
                    console.warn('No competencies file configured for department:', currentDepartment);
                    return;
                }
                const response = await fetch(competenciesFile);
                if (!response.ok) {
                    console.warn('Competencies.csv not found');
                    return;
                }
                const csvText = await response.text();
                
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true
                });
                
                console.log('Competencies parsed:', parsed.data);
                
                // Build a map of competency name -> definition
                parsed.data.forEach(row => {
                    let competency = row['Competency']?.trim() || '';
                    // Remove trailing colon and colons with spaces
                    competency = competency.replace(/:\s*$/, '').replace(/:$/, '').trim();
                    
                    if (competency) {
                        competencyDefinitions[competency] = {
                            focusArea: row['Focus Area']?.trim() || '',
                            description: row['Description']?.trim() || ''
                        };
                        
                        // Also store variations (with/without colon, different cases)
                        const variations = [
                            competency.replace(':', ''),
                            competency + ':',
                            competency.toLowerCase(),
                            competency.replace(/-/g, ' ')
                        ];
                        variations.forEach(v => {
                            if (v && v !== competency) {
                                competencyDefinitions[v] = competencyDefinitions[competency];
                            }
                        });
                    }
                });
                
                console.log('Competency definitions loaded:', competencyDefinitions);
            } catch (error) {
                console.error('Failed to load competency definitions:', error);
            }
        }

        // Load questions from CSV
        async function loadQuestions() {
            try {
                const questionsFile = `disciplines/${currentDiscipline}/Questions.csv`;
                const response = await fetch(questionsFile);
                if (!response.ok) {
                    console.warn('Questions.csv not found for', currentDiscipline);
                    return;
                }
                const csvText = await response.text();
                
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true
                });
                
                console.log('Questions parsed:', parsed.data);
                
                // Clear existing questions
                questionsData = {};
                
                // Build a map of stage_competency -> questions
                parsed.data.forEach(row => {
                    const stage = row['Stage']?.trim() || '';
                    let competency = row['Competency']?.trim() || '';
                    const questions = row['Questions']?.trim() || '';
                    
                    // Normalize competency name (remove trailing colon)
                    competency = competency.replace(/:\s*$/, '').replace(/:$/, '').trim();
                    
                    if (stage && competency && questions) {
                        const key = `${stage}_${competency}`;
                        questionsData[key] = questions;
                        
                        // Also store with variations
                        const keyWithColon = `${stage}_${competency}:`;
                        questionsData[keyWithColon] = questions;
                    }
                });
                
                console.log('Questions data loaded:', questionsData);
            } catch (error) {
                console.error('Failed to load questions:', error);
            }
        }

        // Toggle questions visibility for a competency
        function toggleQuestions(stage, competency) {
            const key = `${stage}_${competency}`;
            showQuestionsState[key] = !showQuestionsState[key];
            updateCompareView();
        }

        // Get questions for a stage/competency
        function getQuestions(stage, competency) {
            // Try exact match first
            let key = `${stage}_${competency}`;
            if (questionsData[key]) return questionsData[key];
            
            // Try without colon
            key = `${stage}_${competency.replace(/:\s*$/, '')}`;
            if (questionsData[key]) return questionsData[key];
            
            // Try with colon
            key = `${stage}_${competency}:`;
            if (questionsData[key]) return questionsData[key];
            
            // Try fuzzy match
            const stageLower = stage.toLowerCase();
            const competencyLower = competency.toLowerCase().replace(/[:\s]/g, '');
            
            for (const [k, v] of Object.entries(questionsData)) {
                const [s, c] = k.split('_');
                if (s.toLowerCase() === stageLower && 
                    c.toLowerCase().replace(/[:\s]/g, '').includes(competencyLower)) {
                    return v;
                }
            }
            
            return null;
        }

        // Format questions as HTML list
        function formatQuestionsAsHtml(questions) {
            if (!questions) return '<span class="no-questions">No questions available</span>';
            
            // Split by bullet points or newlines
            const lines = questions.split(/\n|(?=•)/).filter(line => line.trim());
            
            if (lines.length === 0) return '<span class="no-questions">No questions available</span>';
            
            const listItems = lines.map(line => {
                // Remove leading bullet if present
                const text = line.replace(/^[•\-\*]\s*/, '').trim();
                return text ? `<li>${text}</li>` : '';
            }).filter(item => item);
            
            return `<ul>${listItems.join('')}</ul>`;
        }

        // View toggle functions
        function switchView(view) {
            currentView = view;
            
            // Update dropdown value
            document.getElementById('view-select').value = view;
            
            // Show/hide filters and compare levels sections
            const filtersSection = document.getElementById('filters-section');
            const compareLevelsSection = document.getElementById('compare-levels-section');
            
            if (view === 'rubric') {
                filtersSection.style.display = 'flex';
                compareLevelsSection.style.display = 'flex';
            } else {
                filtersSection.style.display = 'none';
                compareLevelsSection.style.display = 'none';
            }
            
            // Update title and subtitle
            const titleEl = document.getElementById('current-view-title');
            const subtitleEl = document.getElementById('view-subtitle');
            
            if (view === 'rubric') {
                titleEl.textContent = 'Hiring Rubric';
                subtitleEl.textContent = 'Compare competency requirements side-by-side across different designer levels';
                updateCompareView();
            } else if (view === 'definitions') {
                titleEl.textContent = 'Competencies Definition';
                subtitleEl.textContent = 'Understand what each competency means and how it contributes to success';
                renderDefinitionsView();
            } else if (view === 'transcript') {
                titleEl.textContent = 'Transcript Analysis';
                subtitleEl.textContent = 'Analyze interview transcripts to evaluate question coverage per competency';
                renderTranscriptView();
            }
        }

        function renderDefinitionsView() {
            const content = document.getElementById('compare-content');
            const definitions = Object.entries(competencyDefinitions);
            
            // Filter out duplicates (only keep entries with actual unique descriptions)
            const uniqueDefinitions = [];
            const seenDescriptions = new Set();
            
            definitions.forEach(([name, data]) => {
                if (data.description && !seenDescriptions.has(data.description)) {
                    seenDescriptions.add(data.description);
                    uniqueDefinitions.push([name, data]);
                }
            });
            
            if (uniqueDefinitions.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h3>No competency definitions found</h3>
                        <p>Add a Competencies.csv file in the disciplines/${currentDiscipline} folder with Focus Area, Competency, and Description columns.</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="competencies-grid">
                    ${uniqueDefinitions.map(([name, data]) => {
                        return `
                            <div class="competency-definition-card">
                                <div class="competency-definition-header">
                                    <div class="competency-name">${name}</div>
                                </div>
                                <div class="competency-definition-body">
                                    ${data.focusArea ? `<div class="focus-area-badge">${data.focusArea}</div>` : ''}
                                    <div class="competency-definition-text">${data.description}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // OpenAI API Key (to be configured)
        const OPENAI_API_KEY = ''; // Add your API key here

        // Transcript Analysis State
        let transcriptAnalysisResults = null;

        // Render Transcript Analysis View
        function renderTranscriptView() {
            const content = document.getElementById('compare-content');
            const stages = [...new Set(rubricData.map(r => r.interview_stage))].filter(Boolean);
            
            content.innerHTML = `
                <div class="transcript-container">
                    <div class="transcript-input-section">
                        <h3>Interview Details</h3>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="interviewer-name">Interviewer Name</label>
                                <input type="text" id="interviewer-name" placeholder="Enter interviewer name...">
                            </div>
                            <div class="input-group">
                                <label for="interviewee-name">Candidate Name</label>
                                <input type="text" id="interviewee-name" placeholder="Enter candidate name...">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="transcript-stage">Interview Stage</label>
                                <select id="transcript-stage">
                                    <option value="">Select stage...</option>
                                    ${stages.map(s => `<option value="${s}">${getStageDisplayName(s)}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <label for="transcript-input">Interview Transcript</label>
                        <textarea id="transcript-input" class="transcript-textarea" placeholder="Paste your Metaview transcript here..."></textarea>
                        <button class="analyze-btn" id="analyze-btn" onclick="analyzeTranscript()">
                            Analyze Transcript
                        </button>
                    </div>
                    
                    <div class="transcript-results" id="transcript-results">
                        <!-- Results will be rendered here -->
                    </div>
                </div>
            `;
        }

        // Analyze transcript using OpenAI
        async function analyzeTranscript() {
            const interviewer = document.getElementById('interviewer-name').value.trim();
            const interviewee = document.getElementById('interviewee-name').value.trim();
            const stage = document.getElementById('transcript-stage').value;
            const transcript = document.getElementById('transcript-input').value.trim();
            const analyzeBtn = document.getElementById('analyze-btn');
            
            // Validation
            if (!interviewer || !interviewee) {
                alert('Please enter both interviewer and candidate names.');
                return;
            }
            if (!stage) {
                alert('Please select an interview stage.');
                return;
            }
            if (!transcript) {
                alert('Please paste the interview transcript.');
                return;
            }
            if (!OPENAI_API_KEY) {
                alert('OpenAI API key is not configured. Please add your API key to the code.');
                return;
            }
            
            // Get questions for this stage
            const stageQuestions = getQuestionsForStage(stage);
            if (Object.keys(stageQuestions).length === 0) {
                alert('No questions found for this interview stage.');
                return;
            }
            
            // Show loading state
            analyzeBtn.classList.add('loading');
            analyzeBtn.disabled = true;
            
            try {
                const results = await callOpenAIForAnalysis(transcript, stageQuestions);
                transcriptAnalysisResults = {
                    interviewer,
                    interviewee,
                    stage,
                    results
                };
                renderTranscriptResults();
            } catch (error) {
                console.error('Analysis failed:', error);
                alert('Analysis failed: ' + error.message);
            } finally {
                analyzeBtn.classList.remove('loading');
                analyzeBtn.disabled = false;
            }
        }

        // Get all questions for a stage grouped by competency
        function getQuestionsForStage(stage) {
            const result = {};
            
            for (const [key, questions] of Object.entries(questionsData)) {
                const [qStage, ...competencyParts] = key.split('_');
                const competency = competencyParts.join('_');
                
                if (qStage === stage && competency) {
                    result[competency] = questions.split(/\n|(?=•)/)
                        .map(q => q.replace(/^[•\-\*]\s*/, '').trim())
                        .filter(q => q.length > 0);
                }
            }
            
            return result;
        }

        // Call OpenAI API for analysis
        async function callOpenAIForAnalysis(transcript, stageQuestions) {
            const questionsList = [];
            let index = 0;
            
            for (const [competency, questions] of Object.entries(stageQuestions)) {
                questions.forEach(q => {
                    questionsList.push({
                        index: index++,
                        competency,
                        question: q
                    });
                });
            }
            
            const prompt = `You are an interview analysis assistant. Analyze the following interview transcript and determine which of the predefined interview questions were asked or addressed during the conversation.

For each question, respond with whether it was "covered" (the topic was discussed, even if not asked verbatim) or "not_covered".

Return your response as a JSON array with objects containing:
- "index": the question index
- "covered": boolean (true if the question topic was addressed)
- "confidence": number 0-100 (how confident you are in this assessment)

PREDEFINED QUESTIONS:
${questionsList.map(q => `[${q.index}] (${q.competency}): ${q.question}`).join('\n')}

INTERVIEW TRANSCRIPT:
${transcript}

Respond ONLY with the JSON array, no other text.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.3
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }
            
            const data = await response.json();
            const content = data.choices[0].message.content;
            
            // Parse JSON response
            let analysisResults;
            try {
                // Try to extract JSON from the response
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    analysisResults = JSON.parse(jsonMatch[0]);
                } else {
                    analysisResults = JSON.parse(content);
                }
            } catch (e) {
                console.error('Failed to parse OpenAI response:', content);
                throw new Error('Failed to parse analysis results');
            }
            
            // Map results back to competencies
            const competencyResults = {};
            
            for (const [competency, questions] of Object.entries(stageQuestions)) {
                competencyResults[competency] = questions.map((q, i) => {
                    const questionIndex = questionsList.findIndex(
                        ql => ql.competency === competency && ql.question === q
                    );
                    const result = analysisResults.find(r => r.index === questionIndex);
                    return {
                        question: q,
                        covered: result?.covered || false,
                        confidence: result?.confidence || 0
                    };
                });
            }
            
            return competencyResults;
        }

        // Render transcript analysis results
        function renderTranscriptResults() {
            const resultsContainer = document.getElementById('transcript-results');
            if (!transcriptAnalysisResults) {
                resultsContainer.classList.remove('visible');
                return;
            }
            
            const { interviewer, interviewee, stage, results } = transcriptAnalysisResults;
            
            // Calculate overall coverage
            let totalQuestions = 0;
            let coveredQuestions = 0;
            
            for (const questions of Object.values(results)) {
                totalQuestions += questions.length;
                coveredQuestions += questions.filter(q => q.covered).length;
            }
            
            const overallPercentage = totalQuestions > 0 
                ? Math.round((coveredQuestions / totalQuestions) * 100) 
                : 0;
            
            const overallClass = overallPercentage >= 70 ? 'high' : overallPercentage >= 40 ? 'medium' : 'low';
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-info">
                        <div class="results-info-item">
                            <span class="results-info-label">Interviewer</span>
                            <span class="results-info-value">${interviewer}</span>
                        </div>
                        <div class="results-info-item">
                            <span class="results-info-label">Candidate</span>
                            <span class="results-info-value">${interviewee}</span>
                        </div>
                        <div class="results-info-item">
                            <span class="results-info-label">Stage</span>
                            <span class="results-info-value">${getStageDisplayName(stage)}</span>
                        </div>
                    </div>
                    <div class="overall-score">
                        <div class="overall-score-label">Overall Coverage</div>
                        <div class="overall-score-value ${overallClass}">${overallPercentage}%</div>
                    </div>
                </div>
                
                <div class="competency-results-grid">
                    ${Object.entries(results).map(([competency, questions]) => {
                        const covered = questions.filter(q => q.covered).length;
                        const total = questions.length;
                        const percentage = total > 0 ? Math.round((covered / total) * 100) : 0;
                        const scoreClass = percentage >= 70 ? 'high' : percentage >= 40 ? 'medium' : 'low';
                        
                        return `
                            <div class="competency-result-card">
                                <div class="competency-result-header">
                                    <span class="competency-result-title">${competency}</span>
                                    <span class="competency-score-badge ${scoreClass}">${percentage}% (${covered}/${total})</span>
                                </div>
                                <div class="competency-result-body">
                                    ${questions.map(q => `
                                        <div class="question-item ${q.covered ? 'covered' : 'not-covered'}">
                                            ${q.question}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            resultsContainer.classList.add('visible');
        }

        // Modal functions
        function openCompetencyModal(competency) {
            const modal = document.getElementById('competency-modal');
            
            // Find the definition (try various formats)
            let definition = competencyDefinitions[competency] ||
                            competencyDefinitions[competency.replace(':', '')] ||
                            competencyDefinitions[competency + ':'] ||
                            findSimilarCompetency(competency);
            
            document.getElementById('modal-title').textContent = competency;
            
            if (definition) {
                document.getElementById('modal-focus-area').textContent = definition.focusArea || 'General Competency';
                document.getElementById('modal-focus-area').style.display = definition.focusArea ? 'inline-block' : 'none';
                document.getElementById('modal-description').textContent = definition.description || 'No description available.';
            } else {
                document.getElementById('modal-focus-area').style.display = 'none';
                document.getElementById('modal-description').textContent = 'No definition available for this competency.';
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function findSimilarCompetency(name) {
            const nameLower = name.toLowerCase().replace(/[:\s-]/g, '');
            for (const [key, value] of Object.entries(competencyDefinitions)) {
                const keyLower = key.toLowerCase().replace(/[:\s-]/g, '');
                if (keyLower.includes(nameLower) || nameLower.includes(keyLower)) {
                    return value;
                }
            }
            return null;
        }

        function closeModal() {
            const modal = document.getElementById('competency-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function closeModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        function onDataLoaded() {
            const stages = [...new Set(rubricData.map(r => r.interview_stage))].filter(Boolean);
            const levels = [...new Set(rubricData.map(r => r.designer_level))].filter(Boolean);
            const competencies = [...new Set(rubricData.map(r => r.competency))].filter(Boolean);

            // Populate dropdowns
            populateSelect('compare-stage', stages, true, true);
            populateSelectWithAll('compare-competency', competencies, 'All competencies');

            // Update comparison level dropdowns
            updateComparisonLevelDropdowns(levels);

            updateDataStatus('loaded', `${rubricData.length} entries • ${stages.length} stages • ${levels.length} levels`);
            
            // Update last modified info
            updateLastModifiedInfo();
        }

        function populateSelectWithAll(id, options, allLabel) {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">${allLabel}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.add(option);
            });
        }

        async function updateLastModifiedInfo() {
            const infoEl = document.getElementById('last-updated-info');
            let latestDate = null;
            const csvFiles = getCsvFiles();
            
            for (const { file } of csvFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    const lastModified = response.headers.get('Last-Modified');
                    if (lastModified) {
                        const date = new Date(lastModified);
                        if (!latestDate || date > latestDate) {
                            latestDate = date;
                        }
                    }
                } catch (e) {
                    // ignore
                }
            }
            
            if (latestDate) {
                const formatted = latestDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                infoEl.innerHTML = `Last updated: ${formatted}`;
            } else {
                infoEl.style.display = 'none';
            }
        }

        function populateSelect(id, options, keepFirst = true, useDisplayNames = false) {
            const select = document.getElementById(id);
            const firstOption = keepFirst ? select.options[0] : null;
            select.innerHTML = '';
            if (firstOption) select.add(firstOption);
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = useDisplayNames ? getStageDisplayName(opt) : opt;
                select.add(option);
            });
        }

        function updateComparisonLevelDropdowns(levels) {
            const container = document.getElementById('compare-levels-container');
            const selects = container.querySelectorAll('.compare-level-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select level...</option>';
                levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    select.add(option);
                });
                select.value = currentValue;
            });
            updateAddLevelButton();
        }

        function updateDataStatus(status, message) {
            const badge = document.getElementById('data-status');
            const info = document.getElementById('data-info');
            
            badge.className = `status-badge ${status}`;
            badge.innerHTML = `<span class="status-dot"></span>${status === 'loaded' ? 'Loaded' : status === 'error' ? 'Error' : 'Loading...'}`;
            info.textContent = message;
        }

        function showServerInstructions() {
            const content = document.getElementById('primary-content');
            content.innerHTML = `
                <div class="empty-state">
                    <h3>CSV Files Not Found</h3>
                    <p>Please add your CSV files in the <strong>disciplines</strong> folder.</p>
                    <p style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);">If you're running locally, start a server:</p>
                    <code>python3 -m http.server 8000</code>
                    <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">Then open <strong>http://localhost:8000</strong></p>
                </div>
            `;
        }

        // Check if add level button should be visible
        function updateAddLevelButton() {
            const levelSelects = document.querySelectorAll('#compare-levels-container .compare-level-select');
            const allSelected = Array.from(levelSelects).every(s => s.value !== '');
            const addBtn = document.getElementById('add-level-btn');
            if (addBtn) {
                addBtn.style.display = allSelected ? 'flex' : 'none';
            }
        }

        // Compare View
        function addComparisonColumn() {
            const levels = [...new Set(rubricData.map(r => r.designer_level))].filter(Boolean);
            const container = document.getElementById('compare-levels-container');
            
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'filter-group';
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="flex: 1; margin: 0;">Level ${index + 1}</label>
                    <button class="btn btn-remove" onclick="removeComparisonColumn(this)">Remove</button>
                </div>
                <select class="compare-level-select" onchange="onLevelSelectChange()">
                    <option value="">Select level...</option>
                    ${levels.map(l => `<option value="${l}">${l}</option>`).join('')}
                </select>
            `;
            container.appendChild(div);
            updateAddLevelButton();
        }

        // Handle level select change
        function onLevelSelectChange() {
            updateCompareView();
            updateAddLevelButton();
        }

        function removeComparisonColumn(btn) {
            const container = document.getElementById('compare-levels-container');
            if (container.children.length > 1) {
                btn.closest('.filter-group').remove();
                updateCompareView();
            }
        }

        function onStageChange() {
            const stage = document.getElementById('compare-stage').value;
            const competencySelect = document.getElementById('compare-competency');
            const currentValue = competencySelect.value;
            
            // Get competencies for this stage only
            let competencies;
            if (stage) {
                competencies = [...new Set(rubricData
                    .filter(r => r.interview_stage === stage)
                    .map(r => r.competency)
                )].filter(Boolean);
            } else {
                competencies = [...new Set(rubricData.map(r => r.competency))].filter(Boolean);
            }
            
            // Update competency dropdown
            competencySelect.innerHTML = '<option value="">All competencies</option>';
            competencies.forEach(comp => {
                const option = document.createElement('option');
                option.value = comp;
                option.textContent = comp;
                competencySelect.add(option);
            });
            
            // Restore selection if still valid
            if (competencies.includes(currentValue)) {
                competencySelect.value = currentValue;
            }
            
            updateCompareView();
        }

        function updateCompareView() {
            const stage = document.getElementById('compare-stage').value;
            const competencyFilter = document.getElementById('compare-competency').value;
            const levelSelects = document.querySelectorAll('#compare-levels-container .compare-level-select');
            const levels = Array.from(levelSelects).map(s => s.value).filter(Boolean);
            const content = document.getElementById('compare-content');

            if (!stage || levels.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h3>Compare designer levels</h3>
                        <p>Select an interview stage and add levels to compare their requirements side-by-side.</p>
                    </div>
                `;
                return;
            }

            let competencies = [...new Set(rubricData.filter(r => r.interview_stage === stage).map(r => r.competency))];
            
            // Filter by competency if selected
            if (competencyFilter) {
                competencies = competencies.filter(c => c === competencyFilter);
            }

            content.innerHTML = `
                <div class="comparison-grid">
                    ${competencies.map(comp => renderCompareCompetencyRow(stage, comp, levels, selectedScores)).join('')}
                </div>
            `;
        }

        function renderCompareCompetencyRow(stage, competency, levels, scoresToShow) {
            // Check if we have a definition for this competency
            const hasDefinition = competencyDefinitions[competency] || 
                                 competencyDefinitions[competency.replace(':', '')] ||
                                 findSimilarCompetency(competency);
            
            // Check if we have questions for this competency
            const questions = getQuestions(stage, competency);
            const hasQuestions = !!questions;
            
            // Check if questions are currently shown
            const questionsKey = `${stage}_${competency}`;
            const showQuestions = showQuestionsState[questionsKey] || false;
            
            // Get data for each level
            const levelData = levels.map(level => 
                rubricData.find(r => r.interview_stage === stage && r.competency === competency && r.designer_level === level)
            );

            return `
                <div class="competency-row">
                    <div class="competency-header">
                        <div class="competency-title-wrapper">
                            <div class="competency-name">${competency}</div>
                            ${hasDefinition ? `<button class="info-icon" onclick="openCompetencyModal('${competency.replace(/'/g, "\\'")}')">i</button>` : ''}
                        </div>
                        ${hasQuestions ? `
                            <button class="questions-toggle ${showQuestions ? 'active' : ''}" onclick="toggleQuestions('${stage.replace(/'/g, "\\'")}', '${competency.replace(/'/g, "\\'")}')">
                                <span>${showQuestions ? 'Hide questions' : 'See questions'}</span>
                            </button>
                        ` : ''}
                    </div>
                    <div class="compare-table-wrapper">
                        ${showQuestions ? `
                            <div class="questions-panel">
                                <div class="questions-panel-header">
                                    Interview Questions
                                </div>
                                <div class="questions-panel-content">
                                    ${formatQuestionsAsHtml(questions)}
                                </div>
                            </div>
                        ` : ''}
                        <div class="compare-table-main">
                            <div class="compare-table">
                                <div class="compare-table-header">
                                    <div class="compare-table-cell score-label-cell">Score</div>
                                    ${levels.map(level => `
                                        <div class="compare-table-cell level-header-cell">
                                            ${level}
                                        </div>
                                    `).join('')}
                                </div>
                                ${scoresToShow.map(score => `
                                    <div class="compare-table-row ${score <= 2 ? 'fail-row' : 'pass-row'}">
                                        <div class="compare-table-cell score-label-cell">
                                            <span class="score-badge score-${score}">${score}</span>
                                        </div>
                                        ${levelData.map(data => `
                                            <div class="compare-table-cell">
                                                <div class="compare-cell-text">${data?.[`score_${score}`] || '—'}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMiniScoreCard(score, text) {
            return `
                <div class="level-score-item">
                    <span class="score-badge score-${score}">${score}</span>
                    <div class="score-text">${text || '—'}</div>
                </div>
            `;
        }

    </script>
</body>
</html>

